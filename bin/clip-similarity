#!/bin/bash -eu

if [ "$#" -lt 2 ]; then
  echo "Usage: $0 <prompt> <image>... or <folder>"
  exit 1
fi

if [ -d "$2" ]; then
  prompt="$1"
  norm="$(echo "$2" | sed 's|/$||')"

  echo 'file,'"$prompt"

  docker run -it --gpus all -v bash_clip_cache:/root/.cache -v "$norm":/workspace/images bash-clip python3 similarity.py "$prompt" \
  | sed 's|^|'"$norm"'/|'
else
  prompt="$1"
  shift

  paths=""

  for path in "$@"; do
    if [ ! -f "$path" ]; then
      continue
    fi

    paths=$(echo "$paths" "-v $(realpath "$path"):/workspace/images/$(basename "$path")")
  done

  echo 'file,'"$prompt"

  docker run -it --gpus all -v bash_clip_cache:/root/.cache $paths bash-clip python3 similarity.py "$prompt"
fi

